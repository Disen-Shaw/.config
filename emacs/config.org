
#+TITLE: My GNU Emacs Configuration 
#+AUTHOR: Disen-Shaw (DS)
#+STARTUP: content

* TABLE OF DOC :toc:
- [[#basic-ui-configuration][BASIC UI CONFIGURATION]]
  - [[#basic-ui][BASIC UI]]
  - [[#fonts][FONTS]]
- [[#elpaca-package-manager][ELPACA PACKAGE MANAGER]]
- [[#package-configuration][PACKAGE CONFIGURATION]]
  - [[#ui-packages][UI PACKAGES]]
  - [[#resource-package][RESOURCE PACKAGE]]
  - [[#evil-mode][EVIL MODE]]
  - [[#completion][COMPLETION]]
  - [[#general][GENERAL]]
  - [[#document][Document]]

* BASIC UI CONFIGURATION

** BASIC UI

#+begin_src emacs-lisp
  ;; disable auto-backup ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
  (setq make-backup-files nil)
  (setq auto-save-default nil)

  ;; shut the fxxking up
  (setq ring-bell-function 'ignore)

  ;; disable menu bar
  (menu-bar-mode -1)
  ;; disable tool bar
  (tool-bar-mode -1)
  ;; disable tool bar
  (scroll-bar-mode -1)
  ;; display line numbers
  (setq display-line-numbers-type 't)
  (global-display-line-numbers-mode t)
  ;; disable startup buffer
  (setq inhibit-startup-screen t)

  (setq scroll-margin 10)
  (setq scroll-conservatively 101)
#+end_src

** FONTS

#+begin_src emacs-lisp
  ;; I use Maple Mono NF CN
  (defun emacs_basic_settings/setup-fonts ()
    (set-face-attribute 'default nil :font "Maple Mono NF CN-12")
    (set-fontset-font t 'han (font-spec :family "Maple Mono NF CN-12"))
    (set-fontset-font t 'emoji (font-spec :family "Noto Color Emoji"))

    (when (display-graphic-p)
      (set-fontset-font t 'unicode "Symbols Nerd Font Mono" nil 'append)
      (set-fontset-font t 'symbol  "Symbols Nerd Font Mono" nil 'append)
      (set-fontset-font t 'emoji   "Symbols Nerd Font Mono" nil 'append))

    (setq-default line-spacing 0.2)
    (setq org-src-fontify-natively t))
  ;; for emacs --daemon server mode 
  (when (display-graphic-p)
    (emacs_basic_settings/setup-fonts))
  (add-hook 'after-make-frame-functions
  	  (lambda (frame)
  	    (with-selected-frame frame
  	      (when (display-graphic-p frame)
  		(emacs_basic_settings/setup-fonts)))))  
#+end_src

* ELPACA PACKAGE MANAGER
#+begin_src emacs-lisp
  (defvar elpaca-installer-version 0.11)
  (defvar elpaca-directory (expand-file-name "elpaca/" user-emacs-directory))
  (defvar elpaca-builds-directory (expand-file-name "builds/" elpaca-directory))
  (defvar elpaca-repos-directory (expand-file-name "repos/" elpaca-directory))
  (defvar elpaca-order '(elpaca :repo "https://github.com/progfolio/elpaca.git"
                                :ref nil :depth 1 :inherit ignore
                                :files (:defaults "elpaca-test.el" (:exclude "extensions"))
                                :build (:not elpaca--activate-package)))
  (let* ((repo  (expand-file-name "elpaca/" elpaca-repos-directory))
         (build (expand-file-name "elpaca/" elpaca-builds-directory))
         (order (cdr elpaca-order))
         (default-directory repo))
    (add-to-list 'load-path (if (file-exists-p build) build repo))
    (unless (file-exists-p repo)
      (make-directory repo t)
      (when (<= emacs-major-version 28) (require 'subr-x))
      (condition-case-unless-debug err
          (if-let* ((buffer (pop-to-buffer-same-window "*elpaca-bootstrap*"))
                    ((zerop (apply #'call-process `("git" nil ,buffer t "clone"
                                                    ,@(when-let* ((depth (plist-get order :depth)))
                                                        (list (format "--depth=%d" depth) "--no-single-branch"))
                                                    ,(plist-get order :repo) ,repo))))
                    ((zerop (call-process "git" nil buffer t "checkout"
                                          (or (plist-get order :ref) "--"))))
                    (emacs (concat invocation-directory invocation-name))
                    ((zerop (call-process emacs nil buffer nil "-Q" "-L" "." "--batch"
                                          "--eval" "(byte-recompile-directory \".\" 0 'force)")))
                    ((require 'elpaca))
                    ((elpaca-generate-autoloads "elpaca" repo)))
              (progn (message "%s" (buffer-string)) (kill-buffer buffer))
            (error "%s" (with-current-buffer buffer (buffer-string))))
        ((error) (warn "%s" err) (delete-directory repo 'recursive))))
    (unless (require 'elpaca-autoloads nil t)
      (require 'elpaca)
      (elpaca-generate-autoloads "elpaca" repo)
      (let ((load-source-file-function nil)) (load "./elpaca-autoloads"))))
  (add-hook 'after-init-hook #'elpaca-process-queues)
  (elpaca `(,@elpaca-order))
  (elpaca elpaca-use-package
    ;; Enable use-package :ensure support for Elpaca.
    (elpaca-use-package-mode))

#+end_src

* PACKAGE CONFIGURATION
** UI PACKAGES
*** DOOM-THEMES

#+begin_src emacs-lisp
  (use-package doom-themes
    :ensure t
    :config
    (setq doom-themes-visual-bell nil
  	doom-modeline-enable-visual-bell nil)
    (load-theme 'doom-dracula t)
    (doom-themes-org-config))
#+end_src

*** DASHBOARD

#+begin_src emacs-lisp
  (use-package dashboard
    :ensure t
    :init
    (setq initial-buffer-choice 'dashboard-open)
    (setq dashboard-set-heading-icons t)
    (setq dashboard-set-file-icons t)
    (setq dashboard-banner-logo-title "hello world")
    ;;(setq dashboard-startup-banner 'logo) ;; use standard emacs logo as banner
    ;; (setq dashboard-startup-banner 'default)  ;; use custom image as banner
    (setq dashboard-center-content t) ;; set to 't' for centered content
    (setq dashboard-items '((recents . 5)
                            (agenda . 5 )
                            (bookmarks . 3)
                            (projects . 3)
                            (registers . 3)))
    :custom
    (dashboard-modify-heading-icons '((recents . "file-text")
                                      (bookmarks . "book")))
    :config
    (dashboard-setup-startup-hook))
#+end_src
** RESOURCE PACKAGE

*** UI RESOURCE
**** all the icons
#+begin_src emacs-lisp
  ;; icons
  (use-package all-the-icons
    :ensure t
    :if (display-graphic-p)
    :config
    (setq all-the-icons-scale-factor 1.4))

  ;; dired icons
  (use-package all-the-icons-dired
    :ensure t
    :hook
    (dired-mode . (lambda () (all-the-icons-dired-mode 1))))
#+end_src

**** nerd icons

#+begin_src emacs-lisp
  ;; nerd icons
  (use-package nerd-icons
    :ensure t)
#+end_src
**** buffer move
#+begin_src emacs-lisp
  (defun buf-move-up ()
    "Swap the current buffer and the buffer above the split.
    If there is no split, ie now window above the current one, an
    error is signaled."
    (interactive)
    (let* ((other-win (windmove-find-other-window 'up))
    	 (buf-this-buf (window-buffer (selected-window))))
      (if (null other-win)
          (error "No window above this one")
        ;; swap top with this one
        (set-window-buffer (selected-window) (window-buffer other-win))
        ;; move this one to top
        (set-window-buffer other-win buf-this-buf)
        (select-window other-win))))

  (defun buf-move-down ()
    "Swap the current buffer and the buffer under the split.
  If there is no split, ie now window under the current one, an
  error is signaled."
    (interactive)
    (let* ((other-win (windmove-find-other-window 'down))
  	 (buf-this-buf (window-buffer (selected-window))))
      (if (or (null other-win) 
              (string-match "^ \\*Minibuf" (buffer-name (window-buffer other-win))))
          (error "No window under this one")
        ;; swap top with this one
        (set-window-buffer (selected-window) (window-buffer other-win))
        ;; move this one to top
        (set-window-buffer other-win buf-this-buf)
        (select-window other-win))))

  (defun buf-move-left ()
    "Swap the current buffer and the buffer on the left of the split.
  If there is no split, ie now window on the left of the current
  one, an error is signaled."
    (interactive)
    (let* ((other-win (windmove-find-other-window 'left))
  	 (buf-this-buf (window-buffer (selected-window))))
      (if (null other-win)
          (error "No left split")
        ;; swap top with this one
        (set-window-buffer (selected-window) (window-buffer other-win))
        ;; move this one to top
        (set-window-buffer other-win buf-this-buf)
        (select-window other-win))))

  (defun buf-move-right ()
    "Swap the current buffer and the buffer on the right of the split.
  If there is no split, ie now window on the right of the current
  one, an error is signaled."
    (interactive)
    (let* ((other-win (windmove-find-other-window 'right))
  	 (buf-this-buf (window-buffer (selected-window))))
      (if (null other-win)
          (error "No right split")
        ;; swap top with this one
        (set-window-buffer (selected-window) (window-buffer other-win))
        ;; move this one to top
        (set-window-buffer other-win buf-this-buf)
        (select-window other-win))))

#+end_src
*** OTHER FUNCTIONAL RESOURCE
**** popon
#+begin_src emacs-lisp
  (use-package popon
    :ensure t)
#+end_src
**** diminish

This package implements hiding or abbreviation of the modeline displays of minor-modes.

#+begin_src emacs-lisp
  (use-package diminish
    :ensure t)
#+end_src
**** projectile
#+begin_src emacs-lisp
  (use-package projectile
    :ensure t
    :diminish
    :config
    (projectile-mode 1))
#+end_src
**** sudo edit

#+begin_src emacs-lisp
  (use-package sudo-edit
    :ensure t)
#+end_src
**** which-key

which-key package for keymap description.

#+begin_src emacs-lisp
  (use-package which-key
    :ensure t
    :diminish
    :init 
    (which-key-mode 1)
    :config
    (setq which-key-side-window-location 'bottom
  	which-key-sort-order #'which-key-key-order
  	which-key-allow-imprecise-window-fit nil
  	which-key-sort-uppercase-first nil
  	which-key-add-column-padding 1
  	which-key-max-display-columns nil
  	which-key-min-display-lines 6
  	which-key-side-window-slot -10
  	which-key-side-window-max-height 0.5
  	which-key-idle-delay 0.8
  	which-key-max-description-length 25
  	which-key-allow-imprecise-window-fit nil
  	which-key-separator " → " ))
#+end_src

**** neotree

#+begin_src emacs-lisp
  (use-package neotree
    :ensure t
    :config
    (setq neo-theme 'nerd-icons) 
    (setq neo-smart-open t)
    (setq neo-window-fixed-size nil)
    (setq neo-show-hidden-files t)
    (setq neo-autorefresh nil))
#+end_src

**** magit
#+begin_src emacs-lisp
  (use-package transient
    :ensure t)

  (use-package magit
    :ensure t)
#+end_src
**** eshell

#+begin_src emacs-lisp
  ;; eshell syntax highlight
  (use-package eshell-syntax-highlighting
    :ensure t
    :after esh-mode
    :config
    (eshell-syntax-highlighting-global-mode +1))

  (setq eshell-history-size 5000
        ;; eshell-rc-script (concat user-emacs-directory "eshell/profile")
        ;; eshell-aliases-file (concat user-emacs-directory "eshell/aliases")
        eshell-buffer-maximum-lines 5000
        eshell-hist-ignoredups t
        eshell-scroll-to-bottom-on-input t
        eshell-destory-buffer-when-process-dies t
        eshell-visual-commands '("bash" "fish" "htop" "ssh" "top" "zsh"))

  (defun my/toggle-eshell ()
    "Toggle a bottom eshell window."
    (interactive)
    (let* ((buf (get-buffer "*eshell*")))
      ;; 如果不存在，创建一个
      (unless buf
        (save-window-excursion
  	(eshell))
        (setq buf (get-buffer "*eshell*")))

      ;; 如果已经显示 → 收回
      (if (get-buffer-window buf)
  	(progn
            (bury-buffer buf)
            (delete-window (get-buffer-window buf)))
        ;; 否则弹出并切换过去
        (let ((win (display-buffer-in-side-window
                    buf
                    '((side . bottom)
                      (slot . 0)
                      (window-height . 0.3)))))
  	(select-window win)))))
#+end_src

**** vterm

Vterm is a terminal eemulator within emacs. The 'shell-file-name' setting sets the shell to be used in

+ M-x shell
+ M-x term
+ M-x ansi-term
+ M-x vterm
  
By default, the shell is set to 'zsh'.

#+begin_src emacs-lisp
  ;; vterm
  (use-package vterm
    :ensure t
    :init
    (setq shell-file-name "/bin/zsh"
  	vterm-max-scrollback 5000))

  ;; vterm-toggle
  (use-package vterm-toggle
    :ensure t
    :after vterm
    :config
    (setq vterm-toggle-fullscreen-p nil)
    (setq vterm-toggle-scope 'project)
    (add-to-list 'display-buffer-alist
                 '((lambda (buffer-or-name _)
                     (let ((buffer (get-buffer buffer-or-name)))
                       (with-current-buffer buffer
                         (or (equal major-mode 'vterm-mode)
                             (string-prefix-p vterm-buffer-name (buffer-name buffer))))))
                   (display-buffer-reuse-window display-buffer-at-bottom)
                   ;;(display-buffer-reuse-window display-buffer-in-direction)
                   ;;display-buffer-in-direction/direction/dedicated is added in emacs27
                   ;;(direction . bottom)
                   ;;(dedicated . t) ;dedicated is supported in emacs27
                   (reusable-frames . visible)
                   (window-height . 0.3))))
#+end_src

** EVIL MODE
*** EVIL PACKAGES

#+begin_src emacs-lisp

  (use-package evil
    :ensure t
    :init 
    (setq evil-want-keybinding nil)
    (setq evil-want-integration t)
    :demand t
    :config
    ;; my vim keymap ;;;;;;;;;;;;;;;;;;;
    (evil-define-motion my/evil/move-down-5-lines (count)
      "Move down 5 lines."
      :type line
      (evil-next-line (or count 5)))
    (evil-define-motion my/evil/move-up-5-lines (count)
      "Move down 5 lines."
      :type line
      (evil-previous-line (or count 5)))
    (evil-define-motion my/evil/move-beginning-of-line ()
      "Move to beginning of current line."
      :type exclusive
      (evil-first-non-blank))
    (evil-define-motion my/evil/move-end-of-line ()
      "Move to end of current line."
      :type exclusive
      (evil-end-of-line))
    (evil-mode 1))

  (use-package evil-collection
    :ensure t
    :after evil
    :config
    (evil-collection-init))

  ;; jk for normal mode
  (use-package evil-escape
    :ensure t
    :after evil
    :config
    (evil-escape-mode)
    (setq evil-escape-key-sequence "jk"
          evil-escape-delay 0.15))

#+end_src

** COMPLETION
*** frontend
**** corfu

I use [[https://github.com/minad/corfu][Corfu]] as completion frontend.

#+begin_src emacs-lisp
  (use-package corfu
    :ensure t
    :init
    (global-corfu-mode)
    :custom
    (corfu-auto t)
    (corfu-auto-delay 0.1)
    (corfu-auto-prefix 1)          ;; 输入 1 个字符就触发
    (corfu-quit-no-match 'separator)
    (corfu-cycle t)                ;; TAB 循环候选项
    (corfu-preselect 'prompt))
#+end_src

**** kind-icon

#+begin_src emacs-lisp
  (use-package kind-icon
    :ensure t
    :after corfu
    :custom
    (kind-icon-default-face 'corfu-default) ; 让图标背景跟随主题
    :config
    (add-to-list 'corfu-margin-formatters #'kind-icon-margin-formatter))
#+end_src

**** vertico

#+begin_src emacs-lisp
  (use-package vertico
    :ensure t
    :init (vertico-mode))
#+end_src

**** orderless

#+begin_src emacs-lisp
  (use-package orderless
    :ensure t
    :custom (completion-styles '(orderless))
    (completion-category-overrides '((file (styles basic partial-completion)))))
#+end_src

*** Backend

**** cape

I use [[https://github.com/minad/cape][Cape]] as completion backend.

#+begin_src emacs-lisp
  (use-package cape
    :ensure t
    :init
    (add-to-list 'completion-at-point-functions #'cape-dabbrev)
    (add-to-list 'completion-at-point-functions #'cape-file)
    (add-to-list 'completion-at-point-functions #'cape-keyword))
  ;; tab configuration
  (with-eval-after-load 'corfu
    (define-key corfu-map (kbd "TAB") #'corfu-next)
    (define-key corfu-map (kbd "<tab>") #'corfu-next)
    (define-key corfu-map (kbd "<backtab>") #'corfu-previous))
#+end_src

**** language support
#+begin_src emacs-lisp
  ;; cmake
  (use-package cmake-mode
    :ensure nil
    :diminish
    :mode ("CMakeLists\\.txt\\'" "\\.cmake\\'"))
  (use-package cmake-font-lock
    :ensure t
    :hook (cmake-mode . cmake-font-lock-activate))

  ;; lua
  (use-package lua-mode
    :diminish
    :ensure)
#+end_src
**** eglot

#+begin_src emacs-lisp
  (use-package eglot
    :ensure nil
    :diminish
    :config
    :hook ((c-mode c++-mode cmake-mode) . eglot-ensure))
#+end_src
**** flymake

#+begin_src emacs-lisp
  (use-package flymake
    :ensure nil
    :diminish
    :config)
  (use-package flymake-popon
    :ensure t
    :hook (flymake-mode . flymake-popon-mode))
#+end_src

** GENERAL

#+begin_src emacs-lisp
  (use-package general
    :ensure t
    :config
    (general-evil-setup)
    (general-create-definer leader-key
      :states '(normal visual)
      :keymaps 'override
      :prefix "SPC"
      :global-prefix "M-SPC") ;; access leader in insert mode

    ;; normal and visual mode keymap
    (general-define-key
     :states '(normal visual)
     "J" #'my/evil/move-down-5-lines
     "K" #'my/evil/move-up-5-lines
     "H" #'my/evil/move-beginning-of-line
     "L" #'my/evil/move-end-of-line
     "S" #'save-buffer
     "gc" #'comment-line)

    (leader-key
      ;; buffer management
      "b"   '(:ignore t :wk "buffer management")
      "b b" '(switch-to-buffer t :wk "switch buffer")
      "b i" '(ibuffer t :wk "list all buffers")
      "b c" '(kill-current-buffer t :wk "close this buffer")
      "b n" '(next-buffer t :wk "next buffer")
      "b p" '(previous-buffer t :wk "previous buffer")
      "b r" '(revert-buffer t :wk "reload buffer")

      ;; helo information
      "h"   '(:ignore t :wk "help")
      "hf"  '(describe-function :wk "describe function")
      "hv"  '(describe-variable :wk "describe variable")
      "hm"  '(describe-mode :wk "describe mode")
      "hrr" '((lambda () (interactive)
    	      (load-file "~/.config/emacs/init.el")
    	      (load-file "~/.config/emacs/init.el"))
    	    :wk "reload emacs config")

      ;; window management
      "w"   '(:ignore t :wk "windows")
      "w n" '(evil-window-new :wk "new window")
      "w c" '(evil-window-delete :wk "close window")
      "w s" '(evil-window-split :wk "horizontal split window")
      "w v" '(evil-window-vsplit :wk "vertical split window")
      ;; move windows
      "w H" '(buf-move-left :wk "buffer move left")
      "w L" '(buf-move-right :wk "buffer move right")
      "w J" '(buf-move-down :wk "buffer move down")
      "w K" '(buf-move-up :wk "buffer move up")

      ;; file
      "f"   '(:ignore t :wk "file operation")
      "f c" '((lambda () (interactive) (find-file "~/.config/emacs/config.org")) :wk "edit config.org")
      "f r" '(counsel-recentf :wk "find recent files.")
      "f u" '(sudo-edit-find-file :wk "sudo find file")
      "f U" '(sudo-edit :wk "sudo edit file")
      "."   '(find-file :wk "find file")

      ;; shell and terminal 
      "t"   '(:ignore t :wk "shell and terminal")
      "t t" '(vterm-toggle :wk "vterm toggle")
      "t T" '(eshell :wk "eshell"))

    ;; window operation
    (general-define-key
     :states '(normal)
     :keymaps 'override
     :prefix "<tab>"
     "h" '(evil-window-left :wk "switch to left window")
     "l" '(evil-window-right :wk "switch to right window")
     "k" '(evil-window-up :wk "switch to above window")
     "j" '(evil-window-down :wk "switch to below window")
     "t" '(neotree-toggle :wk "neotree"))

    ;; eshell
    (general-define-key
     :states '(normal insert visual)
     "C-t" #'my/toggle-eshell)
    )
#+end_src

** Document
*** ORG-MODE
**** org-mode rendering

Enabling table of contents

#+begin_src emacs-lisp
  (use-package toc-org
    :ensure t
    :commands toc-org-enable
    :init (add-hook 'org-mode-hook 'toc-org-enable))
#+end_src

Enabling org bullets

#+begin_src emacs-lisp
  (add-hook 'org-mode-hook 'org-indent-mode)
  (use-package org-bullets
    :ensure t)
  (add-hook 'org-mode-hook (lambda () (org-bullets-mode 1)))
#+end_src

**** source code block tag expansion

| Typing the below + TAB | Expands to ...                          |
|------------------------+-----------------------------------------|
| <a                     | '#+BEGIN_EXPORT ascii' … '#+END_EXPORT  |
| <c                     | '#+BEGIN_CENTER' … '#+END_CENTER'       |
| <C                     | '#+BEGIN_COMMENT' … '#+END_COMMENT'     |
| <e                     | '#+BEGIN_EXAMPLE' … '#+END_EXAMPLE'     |
| <E                     | '#+BEGIN_EXPORT' … '#+END_EXPORT'       |
| <h                     | '#+BEGIN_EXPORT html' … '#+END_EXPORT'  |
| <l                     | '#+BEGIN_EXPORT latex' … '#+END_EXPORT' |
| <q                     | '#+BEGIN_QUOTE' … '#+END_QUOTE'         |
| <s                     | '#+BEGIN_SRC' … '#+END_SRC'             |
| <v                     | '#+BEGIN_VERSE' … '#+END_VERSE'         |

#+begin_src emacs-lisp
  (require 'org-tempo)
#+end_src

