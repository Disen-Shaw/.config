
#+TITLE: My Emacs Configuration
#+AUTHOR: Disen-Shaw
#+STARTUP: content

* Basic UI Configuration

This is a UI interface configuration, including basic interface settings and font settings.

#+begin_src emacs-lisp

  ;; disable auto-backup
  (setq make-backup-files nil)
  (setq auto-save-default nil)

  ;; auto kill all term process
  (setq confirm-kill-processes nil)

  ;; basic ui settings
  (menu-bar-mode -1)
  (tool-bar-mode -1)
  (scroll-bar-mode -1)
  (setq display-line-numbers-type 't)
  (global-display-line-numbers-mode t)
  (setq inhibit-startup-screen t)

  ;; font settings
  (defun emacs_basic_settings/setup-fonts ()
    (set-face-attribute 'default nil :font "Maple Mono NF CN-12")
    (set-fontset-font t 'han (font-spec :family "Maple Mono NF CN-12"))
    (set-fontset-font t 'emoji (font-spec :family "Noto Color Emoji"))
    (setq-default line-spacing 0.2)
    (setq org-src-fontify-natively t))
  (when (display-graphic-p)
    (emacs_basic_settings/setup-fonts))
  (add-hook 'after-make-frame-functions
  	  (lambda (frame)
  	    (with-selected-frame frame
  	      (when (display-graphic-p frame)
  		(emacs_basic_settings/setup-fonts)))))
#+end_src

* Elpaca

I use elpaca package manager as my default package manager.

#+begin_src emacs-lisp
  (defvar elpaca-installer-version 0.11)
  (defvar elpaca-directory (expand-file-name "elpaca/" user-emacs-directory))
  (defvar elpaca-builds-directory (expand-file-name "builds/" elpaca-directory))
  (defvar elpaca-repos-directory (expand-file-name "repos/" elpaca-directory))
  (defvar elpaca-order '(elpaca :repo "https://github.com/progfolio/elpaca.git"
                                :ref nil :depth 1 :inherit ignore
                                :files (:defaults "elpaca-test.el" (:exclude "extensions"))
                                :build (:not elpaca--activate-package)))
  (let* ((repo  (expand-file-name "elpaca/" elpaca-repos-directory))
         (build (expand-file-name "elpaca/" elpaca-builds-directory))
         (order (cdr elpaca-order))
         (default-directory repo))
    (add-to-list 'load-path (if (file-exists-p build) build repo))
    (unless (file-exists-p repo)
      (make-directory repo t)
      (when (<= emacs-major-version 28) (require 'subr-x))
      (condition-case-unless-debug err
          (if-let* ((buffer (pop-to-buffer-same-window "*elpaca-bootstrap*"))
                    ((zerop (apply #'call-process `("git" nil ,buffer t "clone"
                                                    ,@(when-let* ((depth (plist-get order :depth)))
                                                        (list (format "--depth=%d" depth) "--no-single-branch"))
                                                    ,(plist-get order :repo) ,repo))))
                    ((zerop (call-process "git" nil buffer t "checkout"
                                          (or (plist-get order :ref) "--"))))
                    (emacs (concat invocation-directory invocation-name))
                    ((zerop (call-process emacs nil buffer nil "-Q" "-L" "." "--batch"
                                          "--eval" "(byte-recompile-directory \".\" 0 'force)")))
                    ((require 'elpaca))
                    ((elpaca-generate-autoloads "elpaca" repo)))
              (progn (message "%s" (buffer-string)) (kill-buffer buffer))
            (error "%s" (with-current-buffer buffer (buffer-string))))
        ((error) (warn "%s" err) (delete-directory repo 'recursive))))
    (unless (require 'elpaca-autoloads nil t)
      (require 'elpaca)
      (elpaca-generate-autoloads "elpaca" repo)
      (let ((load-source-file-function nil)) (load "./elpaca-autoloads"))))
  (add-hook 'after-init-hook #'elpaca-process-queues)
  (elpaca `(,@elpaca-order))
  (elpaca elpaca-use-package
    ;; Enable use-package :ensure support for Elpaca.
    (elpaca-use-package-mode))
#+end_src

* UI
** color scheme

I prefer tokyo-night color scheme.

#+begin_src emacs-lisp
  (elpaca
      '(tokyonight-themes
        :host github
        :repo "xuchengpeng/tokyonight-themes")
    (use-package tokyonight-themes
      :config
      (load-theme 'tokyonight-night :no-confirm)))
#+end_src

** doom-modeline

#+begin_src emacs-lisp
  (use-package doom-modeline
    :ensure t
    :init
    (doom-modeline-mode 1)
    :custom
    (doom-modeline-height 25)          ;; 状态栏高度
    (doom-modeline-bar-width 3)        ;; 左侧彩条宽度
    (doom-modeline-buffer-file-name-style 'truncate-upto-project)
    (doom-modeline-icon t)             ;; 显示图标
    (doom-modeline-major-mode-icon t)
    (doom-modeline-major-mode-color-icon t)
    (doom-modeline-lsp t)              ;; 显示 LSP 状态
    (doom-modeline-github nil)
    (doom-modeline-mu4e nil)
    (doom-modeline-irc nil))
#+end_src

* Evil Mode 

I use vim/neovim before emacs, not Emacs, so evil-mode feel very netural to me.

** basic evil-mode settings

#+begin_src emacs-lisp
  (setq evil-want-keybinding nil)
  ;; Keymap plugin
  (use-package key-chord
    :ensure t
    :config (key-chord-mode 1))

  (use-package evil
    :ensure t
    :demand t
    :config
    :after key-chord
    :config
    (key-chord-define evil-insert-state-map "jk" 'evil-normal-state)
    (key-chord-define evil-insert-state-map "kj" 'evil-normal-state)
    (evil-mode 1))

  (use-package evil-collection
    :ensure t
    :after evil
    :config (evil-collection-init))
#+end_src

** dashboard
#+begin_src emacs-lisp
  (use-package dashboard
    :ensure t
    :config
    (dashboard-setup-startup-hook)
    ;; display logo
    (setq dashboard-startup-banner 'official)
    ;; display information
    (setq dashboard-items '((recents . 5)
  			  (projects . 5)
  			  (bookmarks . 5)))
    ;; display tips 
    (setq dashboard-banner-logo-title "hello world")
    ;; random
    (setq dashboard-center-content t)
    (setq dashboard-show-shortcuts nil))
#+end_src
** terminal

#+begin_src emacs-lisp
  ;; eat terminal
  (use-package eat
    :ensure t)

  ;; popper
  (use-package popper
    :ensure t
    :init
    (setq popper-reference-buffers
  	'("\\*eat\\*" "\\*shell\\*" "\\*eshell\\*"))
    (popper-mode 1)
    (popper-echo-mode 1))
#+end_src

** ranger

ranger file manager.

#+begin_src emacs-lisp
    (use-package ranger
      :ensure t
      :config
      (setq ranger-show-hidden t)
      (setq ranger-cleanup-on-disable t)
      (setq ranger-preview-file t)
      (setq ranger-override-dired t)
      (setq ranger-open-file-on-start t)
      (setq ranger-parent-depth 1)
      (setq ranger-width-preview 0.55)
      (setq ranger-max-preview-size 5) ;; 5MB
      (setq ranger-parent-depth 1)
      (setq ranger-cleanup-on-disable t)
  )
#+end_src

** neotree

A NERTtree like file explorer.

#+begin_src emacs-lisp
  (use-package all-the-icons
    :ensure t)
  (use-package nerd-icons
    :ensure t)
  (use-package neotree
    :ensure t
    :config
    (setq neo-theme 'nerd-icons) 
    (setq neo-smart-open t)
    (setq neo-window-fixed-size nil)
    (setq neo-show-hidden-files t)
    (setq neo-autorefresh nil))
#+end_src

** keymap
*** Whitch-key

which-key settings

#+begin_src emacs-lisp
  (use-package which-key
    :ensure t
    :config
    (which-key-mode)
    (setq which-key-idle-delay 0.2))
#+end_src

*** general-keymap

general to define some keybind.

#+begin_src emacs-lisp
  (use-package general
    :ensure t
    :config
    (general-create-definer leader-key
      :states '(normal visual)
      :keymaps 'override
      :prefix "SPC")

    ;; basic vim keymap
    (general-define-key
     :states '(normal visual)
     "J"
     (lambda () (interactive)
       (evil-next-line 5)
       (when (evil-visual-state-p)
         (evil-visual-restore)
         (evil-next-line 5)))
     "K"
     (lambda () (interactive)
       (evil-previous-line 5)
       (when (evil-visual-state-p)
         (evil-visual-restore)
         (evil-previous-line 5)))
     "H"
     (lambda () (interactive)
       (evil-beginning-of-line)
       (when (evil-visual-state-p)
         (evil-visual-restore)
         (evil-beginning-of-line)))
     "L"
     (lambda () (interactive)
       (evil-end-of-line)
       (when (evil-visual-state-p)
         (evil-visual-restore)
         (evil-end-of-line)))
     "S"
     (lambda () (interactive)
       (save-buffer)
       (when (evil-visual-state-p)
         (evil-visual-restore)))
     )
    
    ;; window switch
    (general-define-key
     :states '(normal)
     :keymaps 'override
     :prefix "<tab>"
     "h" 'evil-window-left
     "l" 'evil-window-right
     "k" 'evil-window-up
     "j" 'evil-window-down)

    (leader-key
      "t" '(:ignore t :which-key "terminal")
      "tt" '(neotree-toggle :which-key "NERDtree like file explorer")
      "tv" '(popper-toggle :which-key "terminal togglle")
      "td" '(ranger :which-key "ranger file manager"))
    )
#+end_src
* completion

** frontend

*** corfu

I use [[https://github.com/minad/corfu][Corfu]] as completion frontend.

#+begin_src emacs-lisp
  (use-package corfu
    :ensure t
    :init
    (global-corfu-mode)
    :custom
    (corfu-auto t)
    (corfu-auto-delay 0.1)
    (corfu-auto-prefix 1)          ;; 输入 1 个字符就触发
    (corfu-quit-no-match 'separator)
    (corfu-cycle t)                ;; TAB 循环候选项
    (corfu-preselect 'prompt))
#+end_src

*** kind-icon

#+begin_src emacs-lisp
  (use-package kind-icon
    :ensure t
    :after corfu
    :custom
    (kind-icon-default-face 'corfu-default) ; 让图标背景跟随主题
    :config
    (add-to-list 'corfu-margin-formatters #'kind-icon-margin-formatter))
#+end_src

*** vertico

#+begin_src emacs-lisp
  (use-package vertico
    :ensure t
    :init (vertico-mode))
#+end_src

*** orderless

#+begin_src emacs-lisp
  (use-package orderless
    :ensure t
    :custom (completion-styles '(orderless))
    (completion-category-overrides '((file (styles basic partial-completion)))))
#+end_src

** Backend

*** cape

I use [[https://github.com/minad/cape][Cape]] as completion backend.

#+begin_src emacs-lisp
  (use-package cape
    :ensure t
    :init
    (add-to-list 'completion-at-point-functions #'cape-dabbrev)
    (add-to-list 'completion-at-point-functions #'cape-file)
    (add-to-list 'completion-at-point-functions #'cape-keyword))
  ;; tab configuration
  (with-eval-after-load 'corfu
    (define-key corfu-map (kbd "TAB") #'corfu-next)
    (define-key corfu-map (kbd "<tab>") #'corfu-next)
    (define-key corfu-map (kbd "<backtab>") #'corfu-previous))
#+end_src

*** lsp

#+begin_src emacs-lisp
  (use-package flymake
    :ensure nil)

  (use-package eglot
    :ensure nil
    :hook ((c-mode c++-mode) . eglot-ensure))
#+end_src
